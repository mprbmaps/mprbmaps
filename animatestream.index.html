<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox 3D Vehicles</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js'></script>
    <script src='https://unpkg.com/threebox-plugin/dist/threebox.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
    <div id='map'></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', // Light map style
            center: [-93.265, 44.977], // Center on Minneapolis (adjust as needed)
            zoom: 14,
            pitch: 60, // Tilt for better 3D effect
            bearing: -20,
            antialias: true
        });

        map.on('load', function () {
            // Add 3D Buildings
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                minzoom: 12,
                paint: {
                    'fill-extrusion-color': '#d1d1d1',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 0.6
                }
            });
            
            // Load Threebox for 3D models
            window.tb = new Threebox(map, map.getCanvasContainer(), {
                defaultLights: true,
            });
            
            // Add a source for the ArcGIS Online vehicle locations
            map.addSource('vehicles', {
                type: 'geojson',
                data: 'https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1=1&outFields=*&f=geojson',
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });
            
            // Add vehicle points
            map.addLayer({
                id: 'vehicle-points',
                type: 'symbol',
                source: 'vehicles',
                layout: {
                    'icon-image': 'bus', // Placeholder icon; customize with your own
                    'icon-size': 1.5
                }
            });
            
            // Fetch and add 3D snowplow model to each vehicle
            function addVehicles() {
                fetch('https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1=1&outFields=*&f=geojson')
                    .then(response => response.json())
                    .then(data => {
                        data.features.forEach(vehicle => {
                            const coords = vehicle.geometry.coordinates;
                            tb.loadGLTF('https://your-server.com/snowplow.glb', model => {
                                model.setCoords(coords);
                                model.setRotation({x: 90, y: 0, z: 0});
                                model.setScale(5);
                                tb.add(model);
                            });
                        });
                    });
            }
            
            map.on('style.load', () => {
                map.addLayer(tb.layer);
                addVehicles();
            });
        });
    </script>
</body>
</html>
