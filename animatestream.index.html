<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox + ArcGIS Online Vehicles</title>

    <!-- âœ… Mapbox GL -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

    <!-- âœ… Three.js (Required for Threebox) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- âœ… Threebox Plugin -->
    <script src="https://unpkg.com/threebox-plugin@2.2.0/dist/threebox.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // âœ… Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        // âœ… Initialize Mapbox Map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', // âœ… OpenStreetMap (No Aerial)
            center: [-93.265, 44.977], // âœ… Minneapolis, adjust as needed
            zoom: 14,
            pitch: 60, // âœ… Tilt for 3D view
            bearing: 0,
            antialias: true
        });

        // âœ… Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // âœ… ArcGIS Feature Layer URL (GeoJSON format)
        const arcgisLayerUrl = 'https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1%3D1&outFields=*&f=geojson';

        // âœ… Load 3D buildings
        map.on('load', () => {
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                minzoom: 15,
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 0.6
                }
            });

            // âœ… Load ArcGIS Vehicles
            loadArcGISLayer();
        });

        // âœ… Fetch vehicle locations from ArcGIS Online
        function loadArcGISLayer() {
            fetch(arcgisLayerUrl)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.features) {
                        console.error("ðŸš¨ Error: ArcGIS data is undefined or missing features.");
                        return;
                    }

                    console.log("âœ… Vehicle Data Loaded:", data); // Debugging log

                    map.addSource('vehicles', { type: 'geojson', data: data });

                    map.addLayer({
                        id: 'vehicle-layer',
                        type: 'circle',
                        source: 'vehicles',
                        paint: {
                            'circle-radius': 6,
                            'circle-color': '#ff0000'
                        }
                    });

                    // âœ… Load 3D Snow Plows
                    loadThreeboxModels(data);
                })
                .catch(error => console.error('ðŸš¨ Error loading vehicle data:', error));
        }

        let tb; // âœ… Threebox instance
        let snowPlows = {}; // âœ… Store 3D models

        // âœ… Function to load vehicles as 3D models
        function loadThreeboxModels(data) {
            tb = new Threebox(map, map.getCanvas().getContext('webgl'), { defaultLights: true });

            map.addLayer({
                id: 'custom-3d-models',
                type: 'custom',
                renderingMode: '3d',
                onAdd: function(map, gl) {
                    tb.setupDefaultLights();
                    addVehiclesToThreebox(data);
                },
                render: function(gl, matrix) {
                    tb.update();
                }
            });
        }

        // âœ… Add vehicle 3D models
        function addVehiclesToThreebox(data) {
            data.features.forEach(vehicle => {
                if (!vehicle.geometry || !vehicle.geometry.coordinates) {
                    console.warn("ðŸš¨ Skipping feature with missing coordinates:", vehicle);
                    return;
                }

                const coords = vehicle.geometry.coordinates;
                const vehicleId = vehicle.properties.objectid || vehicle.properties.id;
                const bearing = vehicle.properties.bearing || 0;

                if (snowPlows[vehicleId]) {
                    // âœ… Update existing model position
                    snowPlows[vehicleId].setCoords([coords[0], coords[1], 0]);
                    snowPlows[vehicleId].setRotation({ x: 0, y: bearing, z: 0 });
                } else {
                    // âœ… Load 3D Snow Plow Model
                    tb.loadObj({
                        obj: 'https://models.example.com/snowplow.obj', // Replace with actual model URL
                        type: 'mtl',
                        scale: 5,
                        units: 'meters',
                        rotation: { x: 0, y: bearing, z: 0 },
                        anchor: 'center'
                    }, (model) => {
                        model.setCoords([coords[0], coords[1], 0]);
                        snowPlows[vehicleId] = model;
                        tb.add(model);
                    });
                }
            });
        }

        // âœ… Refresh vehicle positions every 30 seconds
        setInterval(() => {
            fetch(arcgisLayerUrl)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.features) {
                        console.error("ðŸš¨ No valid data received.");
                        return;
                    }
                    addVehiclesToThreebox(data);
                })
                .catch(error => console.error('ðŸš¨ Error refreshing vehicle data:', error));
        }, 30000);
    </script>

</body>
</html>
