<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Vehicle Tracking with Threebox</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/threebox-plugin@2.2.1/dist/threebox.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12', // Update this with the OpenStreet 3D buildings basemap
            center: [-93.2650, 44.9778], // Default center (Minneapolis, MN)
            zoom: 13,
            pitch: 60,
            bearing: 0,
            antialias: true
        });

        let tb; // Threebox instance
        let vehicleModels = {}; // Store vehicle models by ID
        const vehicleLayerURL = "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/LastPlowLocations/FeatureServer/0/query?where=1=1&outFields=*&f=geojson";

        map.on('load', () => {
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                minzoom: 15,
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            });

            tb = new Threebox(map, map.getCanvas().getContext('webgl'), { defaultLights: true });

            map.addLayer({
                id: 'threebox-layer',
                type: 'custom',
                renderingMode: '3d',
                onAdd: () => map.tb = tb,
                render: () => tb.update()
            });

            updateVehicles();
            setInterval(updateVehicles, 5000); // Refresh every 5 seconds
        });

        async function updateVehicles() {
            console.log("ðŸ”„ Fetching vehicle data...");
            try {
                const response = await fetch(vehicleLayerURL);
                const data = await response.json();

                if (!data.features || data.features.length === 0) {
                    console.warn("âš  No vehicles found in ArcGIS layer.");
                    return;
                }

                console.log(`âœ… Vehicles Updated: ${data.features.length}`);

                data.features.forEach(feature => {
                    const id = feature.properties.objectid;
                    const lon = feature.geometry.coordinates[0];
                    const lat = feature.geometry.coordinates[1];
                    const heading = feature.properties.heading || 0;
                    const speed = feature.properties.Kmph || 0;

                    if (vehicleModels[id]) {
                        moveVehicle(id, lon, lat, heading);
                    } else {
                        addVehicleModel(id, lon, lat, heading, speed);
                    }
                });
            } catch (error) {
                console.error("ðŸš¨ Error fetching vehicle data:", error);
            }
        }

        function addVehicleModel(id, lon, lat, heading, speed) {
            tb.loadGLTF('/models/snowplow.glb', model => {
                model.setCoords([lon, lat]);
                model.setRotation({ x: 0, y: heading, z: 0 });
                model.setScale(0.01); // Adjust scale to fit properly
                tb.add(model);
                vehicleModels[id] = model;
            }, { scale: 0.01 });
        }

        function moveVehicle(id, lon, lat, heading) {
            if (vehicleModels[id]) {
                vehicleModels[id].setCoords([lon, lat]);
                vehicleModels[id].setRotation({ x: 0, y: heading, z: 0 });
            }
        }
    </script>
</body>
</html>
