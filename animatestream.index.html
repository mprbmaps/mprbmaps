<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Snow Plows - ArcGIS to Mapbox</title>

    <!-- Mapbox Library -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

    <!-- Threebox Plugin -->
    <script src="https://unpkg.com/threebox-plugin"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // Set your Mapbox token
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        // Initialize the Mapbox map with 3D buildings
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v11', // Use satellite basemap with streets
            center: [-93.265, 44.977], // Default to Minneapolis
            zoom: 15,
            pitch: 60, // Tilting the map for better 3D visualization
            bearing: 0,
            antialias: true
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // ArcGIS Feature Layer URL
        const arcgisUrl = 'https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1%3D1&outFields=*&f=geojson';

        let tb; // Threebox instance
        let snowPlows = {}; // Store 3D models

        // Load the map
        map.on('style.load', () => {
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 0.6
                }
            });

            tb = new Threebox(map, map.getCanvas().getContext('webgl'), {
                defaultLights: true
            });

            map.addLayer({
                id: 'custom-3d-models',
                type: 'custom',
                renderingMode: '3d',
                onAdd: function(map, gl) {
                    tb.setupDefaultLights();
                    loadVehicles();
                },
                render: function(gl, matrix) {
                    tb.update();
                }
            });
        });

        // Fetch and load vehicle locations into Mapbox
        async function loadVehicles() {
            try {
                const response = await fetch(arcgisUrl);
                const data = await response.json();
                
                data.features.forEach(vehicle => {
                    const coords = vehicle.geometry.coordinates;
                    const vehicleId = vehicle.properties.objectid; // Assuming "objectid" is a unique identifier
                    const bearing = vehicle.properties.bearing || 0; // Adjust based on your feature layer field name

                    if (snowPlows[vehicleId]) {
                        // Update position and rotation
                        snowPlows[vehicleId].setCoords([coords[0], coords[1], 0]);
                        snowPlows[vehicleId].setRotation({ x: 0, y: bearing, z: 0 });
                    } else {
                        // Load new 3D model for this vehicle
                        tb.loadObj({
                            obj: 'https://models.example.com/snowplow.obj', // Replace with your 3D model URL
                            type: 'mtl',
                            scale: 5,
                            units: 'meters',
                            rotation: { x: 0, y: bearing, z: 0 },
                            anchor: 'center'
                        }, (model) => {
                            model.setCoords([coords[0], coords[1], 0]);
                            snowPlows[vehicleId] = model;
                            tb.add(model);
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading vehicle data:', error);
            }
        }

        // Refresh vehicle positions every 30 seconds
        setInterval(loadVehicles, 30000);
    </script>

</body>
</html>
