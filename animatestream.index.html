<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox 3D Vehicles</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

    <!-- Threebox Plugin -->
    <script src="https://unpkg.com/threebox-plugin/dist/threebox.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/threebox-plugin/dist/threebox.min.css">
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

    // Initialize Mapbox
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',  // OpenStreetMap 3D basemap
        center: [-93.2650, 44.9778], // Default to Minneapolis
        zoom: 14,
        pitch: 60,
        bearing: 0,
        antialias: true
    });

    // Add Navigation Controls
    map.addControl(new mapboxgl.NavigationControl());

    let tb;  // Threebox instance
    let vehicleModels = {}; // Store 3D models of vehicles

    // Load 3D Buildings
    map.on('load', () => {
        map.addLayer({
            id: '3d-buildings',
            source: 'composite',
            'source-layer': 'building',
            type: 'fill-extrusion',
            paint: {
                'fill-extrusion-color': '#D3D3D3',
                'fill-extrusion-height': ['get', 'height'],
                'fill-extrusion-opacity': 0.6
            }
        });

        // Initialize Threebox after Mapbox loads
        tb = new Threebox(map, map.getCanvas().getContext('webgl'), { defaultLights: true });

        // Load vehicles from ArcGIS Online
        loadVehicleLocations();
        setInterval(loadVehicleLocations, 5000); // Update every 5 seconds
    });

    // Fetch vehicle locations from ArcGIS Online
    async function loadVehicleLocations() {
        const url = "https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1=1&outFields=*&f=json";

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (!data.features || data.features.length === 0) {
                console.error("No vehicles found in ArcGIS layer.");
                return;
            }

            // Process each vehicle location
            data.features.forEach(feature => {
                const id = feature.attributes.OBJECTID;
                const longitude = feature.geometry.x;
                const latitude = feature.geometry.y;
                const bearing = feature.attributes.bearing || 0;

                // If the vehicle already exists, update its position
                if (vehicleModels[id]) {
                    vehicleModels[id].setCoords([longitude, latitude]);
                    vehicleModels[id].setRotation({ z: bearing });
                } else {
                    // Create a new 3D model for this vehicle
                    addVehicleModel(id, longitude, latitude, bearing);
                }
            });

        } catch (error) {
            console.error("Error loading vehicle data:", error);
        }
    }

    // Add a 3D Snowplow Model at given coordinates
    function addVehicleModel(id, lon, lat, bearing) {
        tb.loadObj({
            obj: 'https://raw.githubusercontent.com/threebox/3D-models/master/vehicles/snowplow.obj',  // Example OBJ file
            type: 'mtl',  // Material file included
            scale: 5,  // Adjust scale
            units: 'meters',
            rotation: { x: 90, y: 0, z: bearing },
            anchor: 'center'
        }, model => {
            model.setCoords([lon, lat]);
            tb.add(model);
            vehicleModels[id] = model;
        });
    }
</script>

</body>
</html>
