<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Locations - ArcGIS to Mapbox</title>
    
    <!-- Mapbox Library -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // Set your Mapbox token
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        // Initialize the Mapbox map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-93.265, 44.977], // Default to Minneapolis
            zoom: 12
        });

        // ArcGIS Feature Layer URL
        const arcgisUrl = 'https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1%3D1&outFields=*&f=geojson';

        // Fetch data from ArcGIS Online and add to Mapbox
        async function loadVehicles() {
            try {
                const response = await fetch(arcgisUrl);
                const data = await response.json();
                
                // Remove existing layers if they exist
                if (map.getSource('vehicles')) {
                    map.getSource('vehicles').setData(data);
                } else {
                    // Add vehicle data as a Mapbox layer
                    map.addSource('vehicles', {
                        type: 'geojson',
                        data: data
                    });

                    map.addLayer({
                        id: 'vehicle-points',
                        type: 'symbol',
                        source: 'vehicles',
                        layout: {
                            'icon-image': 'car-15', // Default Mapbox car icon
                            'icon-size': 1.5,
                            'text-field': ['get', 'name'], // Assuming "name" is a field in your feature layer
                            'text-offset': [0, 1.5],
                            'text-anchor': 'top'
                        },
                        paint: {
                            'text-color': '#ff0000'
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading vehicle data:', error);
            }
        }

        // Load vehicles when the map is loaded
        map.on('load', loadVehicles);

        // Refresh vehicle positions every 30 seconds
        setInterval(loadVehicles, 30000);
    </script>

</body>
</html>
