<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Animation with Three.js & Threebox</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

    <!-- Three.js & Threebox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.0/dist/threebox.min.js"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',  // No satellite
            center: [-93.265, 44.9778],  // Minneapolis
            zoom: 14,
            pitch: 60,
            bearing: 0,
            antialias: true
        });

        // Wait for the map to load
        map.on('load', function () {
            console.log("Map Loaded");

            // ðŸ“Œ ADD 3D BUILDINGS
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            });

            // ðŸ“Œ LOAD VEHICLE LOCATIONS
            loadVehicles();
        });

        // ðŸšœ Function to Load Vehicle Locations from ArcGIS Online
        function loadVehicles() {
            const arcGISURL = "https://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/maps/arcgis/rest/services/kubota_stream_public/MapServer/0/query?where=1%3D1&outFields=*&f=geojson";
            
            fetch(arcGISURL)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.features) {
                        throw new Error("ArcGIS Online data is undefined or missing features.");
                    }

                    console.log("Vehicle Data Loaded:", data);

                    // Add vehicles as a Mapbox layer
                    map.addSource("vehicles", {
                        type: "geojson",
                        data: data
                    });

                    map.addLayer({
                        id: "vehicles-layer",
                        type: "symbol",
                        source: "vehicles",
                        layout: {
                            "icon-image": "bus-15",  // Change to custom snowplow icon if available
                            "icon-size": 1.5
                        }
                    });

                })
                .catch(error => console.error("Error loading vehicle data:", error));
        }

        // ðŸ“Œ THREEBOX SETUP FOR 3D VEHICLE MODEL
        let tb;
        map.on("style.load", function () {
            tb = new Threebox(map, map.getCanvas().getContext("webgl"), { defaultLights: true });

            map.addLayer({
                id: "custom-threebox",
                type: "custom",
                renderingMode: "3d",
                onAdd: function (map, mbxContext) {
                    const loader = new THREE.GLTFLoader();
                    loader.load('https://models.readyplayer.me/avatar.glb', function (gltf) {
                        const model = gltf.scene;
                        model.scale.set(10, 10, 10);
                        tb.add(model);
                    });
                },
                render: function () {
                    tb.update();
                }
            });
        });

    </script>
</body>
</html>
