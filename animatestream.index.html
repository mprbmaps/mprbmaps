<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Vehicle Tracking</title>
    
    <!-- Mapbox & Threebox -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.0/dist/threebox.min.js"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // âœ… Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoibW5tYXBwZXIiLCJhIjoiY2xyejk5NjRjMWwzYTJpbzU3aGhsa2tsNSJ9.xx2G54WK6pVlfAeS45gOpA';

        // âœ… Initialize Mapbox
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', // 3D Buildings with OpenStreetMap
            center: [-93.2650, 44.9778], // Default center (Minneapolis, adjust as needed)
            zoom: 14,
            pitch: 60,
            bearing: 0,
            antialias: true
        });

        let tb; // Threebox instance
        let vehicleModels = {}; // Store active vehicles

        // âœ… Add 3D Buildings
        map.on('style.load', () => {
            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                type: 'fill-extrusion',
                paint: {
                    'fill-extrusion-color': '#AAAAAA',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 0.6
                }
            });

            // âœ… Initialize Threebox
            tb = new Threebox(
                map,
                map.getCanvas().getContext('webgl'),
                { defaultLights: true }
            );
            map.addLayer({ id: 'custom-3d-models', type: 'custom', renderingMode: '3d', onAdd: () => {}, render: () => tb.update() });

            // âœ… Start Streaming Vehicles
            connectToStreamServer();
        });

        // âœ… WebSocket URL for ArcGIS Velocity StreamServer
        const streamUrl = "wss://us-iot.arcgis.com/usadvanced00/mu31z9haakdc3w69/streams/arcgis/rest/services/Test/StreamServer/subscribe";

        function connectToStreamServer() {
            console.log("ðŸ”— Connecting to ArcGIS Velocity StreamServer...");

            const socket = new WebSocket(streamUrl);

            socket.onopen = function() {
                console.log("âœ… Connected to StreamServer");
                socket.send(JSON.stringify({
                    where: "1=1",
                    outFields: "*",
                    returnGeometry: true
                }));
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (!data.features || data.features.length === 0) {
                    console.warn("âš  No active vehicle updates received.");
                    return;
                }

                data.features.forEach(feature => {
                    if (!feature.geometry) {
                        console.error("ðŸš¨ Error: Vehicle geometry is missing.");
                        return;
                    }

                    const id = feature.attributes.OBJECTID;
                    const longitude = feature.geometry.x;
                    const latitude = feature.geometry.y;
                    const bearing = feature.attributes.bearing || 0;

                    if (vehicleModels[id]) {
                        // Update vehicle position and rotation
                        vehicleModels[id].setCoords([longitude, latitude]);
                        vehicleModels[id].setRotation({ z: bearing });
                    } else {
                        // Add a new vehicle model
                        addVehicleModel(id, longitude, latitude, bearing);
                    }
                });
            };

            socket.onerror = function(error) {
                console.error("ðŸš¨ WebSocket Error:", error);
            };

            socket.onclose = function() {
                console.warn("âš  StreamServer connection closed. Reconnecting in 5 seconds...");
                setTimeout(connectToStreamServer, 5000); // Auto-reconnect after disconnect
            };
        }

        // âœ… Load a 3D Snow Plow Model
        function addVehicleModel(id, lon, lat, bearing) {
            const modelUrl = 'https://threejs.org/examples/models/gltf/SnowPlow.glb'; // Use a real 3D model URL

            tb.loadObj({ obj: modelUrl, type: 'gltf', scale: 5, units: 'meters' }, function(model) {
                model.setCoords([lon, lat]);
                model.setRotation({ z: bearing });
                tb.add(model);
                vehicleModels[id] = model;
            });
        }
    </script>

</body>
</html>
