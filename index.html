<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work Order Dashboard</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
<style>
 html, body {
  height: 100%;
  margin: 0;
  padding: 0;
 }
 #viewDiv {
  height: 100%;
  width: calc(100% - 320px);
  position: absolute;
  right: 0;
 }
 #sidePanel {
  width: 300px;
  height: 100%;
  position: absolute;
  left: 0;
  overflow-y: auto;
  background-color: lightgray; 
  padding: 10px;
  z-index: 1; 
 }
 .feature-item {
  width: 270px;
  background-color: white; 
  margin-bottom: 15px;
  padding: 15px;
  cursor: pointer;
  position: relative; /* To position the status indicator */
 }

 .status-indicator {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50%;
    height: 10px;
  }

  .work-order-summary {
    margin-bottom: 10px;
  }
</style>
<script src="https://js.arcgis.com/4.24/"></script>
</head>
<body>
<div id="sidePanel">Work Orders:</div>
<div id="viewDiv"></div>

<script>
require([
 "esri/Map",
 "esri/views/MapView",
 "esri/layers/FeatureLayer",
 "esri/widgets/Editor",
 "esri/identity/OAuthInfo",
 "esri/identity/IdentityManager",
 "esri/rest/support/AttachmentQuery",
 "esri/portal/Portal" 
], function(Map, MapView, FeatureLayer, Editor, OAuthInfo, IdentityManager, AttachmentQuery, Portal) { 

   const statusColors = {
     "New": "gray",
     "In Progress": "orange",
     "Completed": "green",
     "Urgent": "red",
     // ... more statuses 
   };

  var info = new OAuthInfo({
    appId: "ti3fi1FqvHE2Hhyw",
    popup: false
  });
  IdentityManager.registerOAuthInfos([info]);

  IdentityManager.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
    const portal = new Portal(); 
    portal.load().then(function() {
      const fullName = portal.user.fullName;
      const userInfo = IdentityManager.credentials[0].userId; 

      const map = new Map({ basemap: "streets" });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-94.305, 45.027],
        zoom: 13 
      });

      const featureLayer = new FeatureLayer({
        url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/Requests_41a56ed49cbb4662927825495afe2ae8/FeatureServer/0",
        outFields: ["*"],
        popupEnabled: false
      });

      map.add(featureLayer);
      featureLayer.definitionExpression = `assignedto = '${userInfo}'`; 

      const editor = new Editor({
        view: view,
        layerInfos: [{
          layer: featureLayer,
          addEnabled: false,
          deleteEnabled: false
        }]
      });
      view.ui.add(editor, "top-right"); 

      view.when(() => { 

        featureLayer.queryFeatures({
          where: `assignedto = '${userInfo}'`,
          returnGeometry: true,
          outFields: ["OBJECTID", "status", "assignedto", "address", "issue"] 
        }).then(function(results) {

          const sidePanel = document.getElementById("sidePanel"); 

          results.features.forEach(function(feature) {
            const workOrderItemDiv = createWorkOrderItemDiv(feature);
            sidePanel.appendChild(workOrderItemDiv); 
          }); 

        }).catch(console.error); // Error handling
      });
    }).catch(function(error) {
      console.error("Error loading the portal:", error); 
    });
  }).catch(function(error) {
    console.error("Error during sign-in:", error); 
  });


  // **** IMPORTANT: Function to Create Work Order Divs ****
  function createWorkOrderItemDiv(feature) {
    const workOrderItemDiv = document.createElement("div");
    workOrderItemDiv.classList.add("feature-item");

    // Status indicator
    const statusIndicator = document.createElement("div");
    statusIndicator.classList.add("status-indicator");
    statusIndicator.style.backgroundColor = statusColors[feature.attributes.status];

    workOrderItemDiv.innerHTML = `
  <div class="work-order-summary">
    Work Order ID: ${feature.attributes.OBJECTID} <br>
    Address: ${feature.attributes.address} <br>
    Issue: ${feature.attributes.issue} <br>
    Assigned To: ${fullName}
  </div>`;
workOrderItemDiv.appendChild(statusIndicator);
    return workOrderItemDiv; // Ensure this exists
  }

}); 
</script>
</body>
</html>
