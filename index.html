<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work Order Dashboard</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
<style>
 html, body {
  height: 100%;
  margin: 0;
  padding: 0;
 }
 #viewDiv {
  height: 100%;
  width: calc(100% - 320px);
  position: absolute;
  right: 0;
 }
 #sidePanel {
  width: 300px;
  height: 100%;
  position: absolute;
  left: 0;
  overflow-y: auto;
  background-color: lightgray;
  padding: 10px;
  z-index: 1;
 }
 .feature-item {
  width: 270px;
  background-color: white;
  margin-bottom: 15px;
  padding: 15px;
  cursor: pointer;
  z-index: 5;
 }
 .attachment-container {
   position: relative;
   overflow: hidden;
   white-space: nowrap;
   width: 100%;
   height: 100px; /* Fixed height to ensure layout consistency */
 }
 .arrow-left, .arrow-right {
   position: absolute;
   top: 50%;
   transform: translateY(-50%);
   background-color: rgba(0, 0, 0, 0.5);
   color: white;
   padding: 10px;
   cursor: pointer;
   user-select: none;
 }
 .arrow-left { left: 10px; }
 .arrow-right { right: 10px; }
</style>
</head>
<body>
<div id="sidePanel">Work Orders:</div>
<div id="viewDiv"></div>

<script src="https://js.arcgis.com/4.24/"></script>
<script>
require([
 "esri/Map",
 "esri/views/MapView",
 "esri/layers/FeatureLayer",
 "esri/widgets/Editor",
 "esri/identity/OAuthInfo",
 "esri/identity/IdentityManager",
 "esri/rest/support/AttachmentQuery",
 "esri/portal/Portal"
], function(Map, MapView, FeatureLayer, Editor, OAuthInfo, IdentityManager, AttachmentQuery, Portal) {
  var info = new OAuthInfo({
    appId: "ti3fi1FqvHE2Hhyw",
    popup: false
  });
  IdentityManager.registerOAuthInfos([info]);

  IdentityManager.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
    const portal = new Portal();
    portal.load().then(function() {
      const fullName = portal.user.fullName;
      console.log("Logged in user's full name:", fullName);

      const userInfo = IdentityManager.credentials[0].userId;
      console.log("User Info:", userInfo);

      const map = new Map({ basemap: "streets" });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-94.305, 45.027],
        zoom: 13
      });

      const featureLayer = new FeatureLayer({
        url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/Requests_41a56ed49cbb4662927825495afe2ae8/FeatureServer/0",
        outFields: ["*"],
        popupEnabled: false
      });

      map.add(featureLayer);
      featureLayer.definitionExpression = `assignedto = '${userInfo}'`;

      const editor = new Editor({
        view: view,
        layerInfos: [{
          layer: featureLayer,
          addEnabled: false,
          deleteEnabled: false
        }]
      });
      view.ui.add(editor, "top-right");

      view.when(() => {
        featureLayer.queryFeatures({
          where: `assignedto = '${userInfo}'`,
          returnGeometry: true,
          outFields: ["OBJECTID", "status", "assignedto"]
        }).then(function(results) {
          const sidePanel = document.getElementById("sidePanel");
          results.features.forEach(function(feature) {
            const div = document.createElement("div");
            div.classList.add("feature-item");
            div.innerHTML = `<div>Work Order ID: ${feature.attributes.OBJECTID}</div>
                              <div>Status: ${feature.attributes.status}</div>
                              <div>Assigned To: ${fullName}</div>`;
            const attachmentContainer = document.createElement('div');
            attachmentContainer.classList.add('attachment-container');
            div.appendChild(attachmentContainer);

            const attachmentQuery = new AttachmentQuery();
            attachmentQuery.objectIds = [feature.attributes.OBJECTID];
            featureLayer.queryAttachments(attachmentQuery).then(function(attachmentResults) {
              const attachments = attachmentResults[feature.attributes.OBJECTID];
              if (attachments && attachments.length > 0) {
                attachments.forEach((attachment, index) => {
                  const img = document.createElement("img");
                  img.src = attachment.url;
                  img.style.maxWidth = "100px";
                  img.style.height = "auto";
                  img.style.display = "inline-block";
                  attachmentContainer.appendChild(img);
                });
                const leftArrow = document.createElement('div');
                leftArrow.classList.add('arrow-left');
                leftArrow.textContent = '<';
                attachmentContainer.appendChild(leftArrow);

                const rightArrow = document.createElement('div');
                rightArrow.classList.add('arrow-right');
                rightArrow.textContent = '>';
                attachmentContainer.appendChild(rightArrow);

                leftArrow.addEventListener('click', function() { scrollAttachments(attachmentContainer, -1); });
                rightArrow.addEventListener('click', function() { scrollAttachments(attachmentContainer, 1); });
              } else {
                div.innerHTML += "<p>No attachments found.</p>";
              }
              sidePanel.appendChild(div);
            });
          });
        }).catch(console.error);
      });
    }).catch(function(error) {
      console.error("Error loading the portal:", error);
    });
  }).catch(function(error) {
    console.error("Error during sign-in:", error);
  });
});

function scrollAttachments(container, direction) {
  const scrollAmount = 100; // Adjust this value based on your needs
  if (direction === -1) {
    // Scroll left
    container.scrollLeft -= scrollAmount;
  } else {
    // Scroll right
    container.scrollLeft += scrollAmount;
  }
}
</script>
</body>
</html>
