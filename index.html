<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew Leader Dashboard</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        body {
            font-family: Avenir Next, sans-serif;
            display: flex;
        }
        #crewLeaderContainer {
            width: 200px;
            height: 100vh;
            overflow-y: auto;
            background-color: #f0f0f0;
            padding: 10px;
        }
        .crew-leader {
            margin: 5px 0;
            padding: 10px;
            background-color: #0079c1;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }
        #serviceAreaContainer {
            flex-grow: 1;
            padding: 10px;
        }
        .service-area, .park {
            margin: 10px;
            padding: 10px;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .service-area-name, .plus-icon {
            font-weight: bold;
            cursor: pointer;
        }
        .service-area-content {
            display: none; /* Initially hide the content */
        }
        .expand-collapse-icon {
    display: inline-block;
    margin-right: 5px; /* Adjust as needed */
}

.service-area-name {
    display: inline-block;
}

    </style>
</head>
<body>
<div id="crewLeaderContainer"></div>
<div id="serviceAreaContainer"></div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager",
    "esri/layers/FeatureLayer",
    "esri/rest/support/Query"
], function(OAuthInfo, esriId, FeatureLayer, Query) {
    var info = new OAuthInfo({
        appId: "ti3fi1FqvHE2Hhyw",
        popup: false
    });
    esriId.registerOAuthInfos([info]);

    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
        loadCrewLeaders();
    }).catch(function() {
        esriId.getCredential(info.portalUrl + "/sharing");
    });

    function loadCrewLeaders() {
        var layer = new FeatureLayer({
            url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/CrewleaderAssignments/FeatureServer/0"
        });

        var query = layer.createQuery();
        query.where = "1=1";
        query.outFields = ["Name_Primary", "ASMCrewLeader", "ASMCrewLeaderPhone", "ASMCrewLeaderEmail", "Maintenance_SA", "OBJECTID"];
        query.returnGeometry = false;
        layer.queryFeatures(query).then(function(response) {
            processFeatures(response.features);
        });
    }

    function processFeatures(features) {
    const crewLeaderMap = {};
    const serviceAreasMap = {};

    features.forEach(feature => {
        const { Maintenance_SA, Name_Primary, ASMCrewLeader } = feature.attributes;

        // Handling park names
        if (!serviceAreasMap[Maintenance_SA]) {
            serviceAreasMap[Maintenance_SA] = new Set();
        }
        const parkNames = Name_Primary.split('"').filter(parkName => parkName.trim().length > 0);
        parkNames.forEach(parkName => serviceAreasMap[Maintenance_SA].add(parkName.trim()));

        // Handling CrewLeader names
        if (ASMCrewLeader && !crewLeaderMap[ASMCrewLeader]) {
            crewLeaderMap[ASMCrewLeader] = { serviceAreas: new Set(), parks: [] };
        }
        if (ASMCrewLeader) {
            crewLeaderMap[ASMCrewLeader].serviceAreas.add(Maintenance_SA);
            parkNames.forEach(parkName => {
                if (!crewLeaderMap[ASMCrewLeader].parks.includes(parkName)) {
                    crewLeaderMap[ASMCrewLeader].parks.push(parkName);
                }
            });
        }
    });

    populatePeople(crewLeaderMap);
    populateServiceAreas(serviceAreasMap, crewLeaderMap);
}

function populatePeople(crewLeaderMap) {
    const container = document.getElementById('crewLeaderContainer');
    container.innerHTML = ''; // Clear existing content

    // Alphabetize the leader names
    const sortedLeaderNames = Object.keys(crewLeaderMap).sort();
    sortedLeaderNames.forEach(leaderName => {
        const leaderDiv = document.createElement('div');
        leaderDiv.className = 'crew-leader';
        leaderDiv.textContent = leaderName;
        container.appendChild(leaderDiv);
    });
}

function populateServiceAreas(serviceAreasMap, crewLeaderMap) {
    console.log('Starting to populate service areas', serviceAreasMap); // Log the initial data

    const container = document.getElementById('serviceAreaContainer');
    container.innerHTML = ''; // Clear existing content

    Object.entries(serviceAreasMap).sort((a, b) => a[0].localeCompare(b[0])).forEach(([area, parksSet]) => {
        console.log(`Processing area: ${area}`, parksSet); // Log the area being processed, showing it's a Set

        const areaDiv = document.createElement('div');
        areaDiv.className = 'service-area';

        const nameContainerDiv = document.createElement('div');
        nameContainerDiv.className = 'name-container';

        const expandCollapseIcon = document.createElement('span');
        expandCollapseIcon.className = 'expand-collapse-icon';
        expandCollapseIcon.textContent = '▶'; // You can customize the icon here

        const nameDiv = document.createElement('div');
        nameDiv.className = 'service-area-name';
        nameDiv.textContent = area;

        nameContainerDiv.appendChild(expandCollapseIcon);
        nameContainerDiv.appendChild(nameDiv);

        areaDiv.appendChild(nameContainerDiv);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'service-area-content';
        areaDiv.appendChild(contentDiv);

        // Convert the Set to an array and sort alphabetically
        const sortedParks = [...parksSet].sort();

        // Iterate through sorted park names and add them to the service area content
sortedParks.forEach(parkName => {
    console.log(`Adding park: ${parkName} to area: ${area}`); // Log each park being added

    // Create a container for the park
    const parkContainer = document.createElement('div');
    parkContainer.className = 'park-container';

    // Create the park <div> element
    const parkDiv = document.createElement('div');
    parkDiv.className = 'park';
    parkDiv.textContent = parkName;

    // Append the parkDiv to the park container
    parkContainer.appendChild(parkDiv);

    // Append the park container to the contentDiv
    contentDiv.appendChild(parkContainer);
});

// After adding all parks, iterate again for each park to append its corresponding crew leader(s)
sortedParks.forEach(parkName => {
    // Find the container for the park
    const parkContainers = contentDiv.getElementsByClassName('park-container');
    Array.from(parkContainers).forEach(parkContainer => {
        if (parkContainer.firstChild.textContent === parkName) {
            // Check if ASMCrewLeader is responsible for this park and prepopulate their name
            Object.entries(crewLeaderMap).forEach(([leaderName, leaderData]) => {
                if (leaderData.parks.includes(parkName)) {
                    const leaderTile = document.createElement('div');
                    leaderTile.className = 'crew-leader';
                    leaderTile.textContent = leaderName;
                    parkContainer.appendChild(leaderTile); // Append the leaderTile to the parkContainer
                }
            });
        }
    });
});


        expandCollapseIcon.addEventListener('click', function() {
            const isExpanded = contentDiv.style.display === 'block';
            contentDiv.style.display = isExpanded ? 'none' : 'block';
            expandCollapseIcon.textContent = isExpanded ? '▶' : '▼'; // Change the icon based on the current state
        });

        container.appendChild(areaDiv);
    });

    console.log('Finished populating service areas'); // Log completion
}


});
</script>
</body>
</html>
