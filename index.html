<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Update Feature Layer Fields</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css">
    <style>
        html, body, #viewDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #updateButton {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 99;
            background-color: #fff;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="updateButton">Update Plowing Hours</div>
    <div id="viewDiv"></div>

    <script src="https://js.arcgis.com/4.23/"></script>
    <script>
        require([
          "esri/config",
          "esri/Map",
          "esri/views/MapView",
          "esri/layers/FeatureLayer",
          "esri/request",
          "esri/identity/OAuthInfo",
          "esri/identity/IdentityManager"
        ], function(esriConfig, Map, MapView, FeatureLayer, esriRequest, OAuthInfo, esriId) {

          const oauthInfo = new OAuthInfo({
            appId: "ti3fi1FqvHE2Hhyw",
            popup: true
          });
          esriId.registerOAuthInfos([oauthInfo]);

          esriId.checkSignInStatus(oauthInfo.portalUrl + "/sharing").then(
            function() {
              console.log("Signed in");
              initApp();
            }
          ).catch(function() {
              esriId.getCredential(oauthInfo.portalUrl + "/sharing");
          });

          function initApp() {
            const map = new Map({
              basemap: "arcgis-topographic"
            });

            const view = new MapView({
              container: "viewDiv",
              map: map,
              zoom: 10,
              center: [-100, 40]
            });

            const snowRoutesLayer = new FeatureLayer({
              url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/SnowRoutes_9d4babee9d65431ebe5027eb4b6ea135/FeatureServer"
            });
            map.add(snowRoutesLayer);

            document.getElementById("updateButton").addEventListener("click", function() {
              fetchAndUpdateData();
            });
          }

          function fetchAndUpdateData() {
            // Assume sourceFeatures is populated with your source data
            let sourceFeatures; // Placeholder - populate this with actual data

            const query = snowRoutesLayer.createQuery();
            query.where = "1=1";
            query.outFields = ["OBJECTID", "snowroutesegmentid"];

            snowRoutesLayer.queryFeatures(query).then(function(response) {
              const targetFeatures = response.features;

              const updates = sourceFeatures.map(sourceFeature => {
                const matchedTargetFeature = targetFeatures.find(targetFeature => 
                  targetFeature.attributes.snowroutesegmentid === sourceFeature.attributes.segmentID);

                if (matchedTargetFeature) {
                  return {
                    attributes: {
                      OBJECTID: matchedTargetFeature.attributes.OBJECTID,
                      Hrs21stPlow_2024_2: sourceFeature.attributes.hours
                    }
                  };
                }
                return null;
              }).filter(update => update !== null);

              if (updates.length > 0) {
                snowRoutesLayer.applyEdits({
                  updateFeatures: updates
                }).then(function(results) {
                  console.log("Update results:", results);
                }).catch(function(error) {
                  console.error("Error applying updates:", error);
                });
              } else {
                console.log("No matching features found to update.");
              }
            }).catch(function(error) {
              console.error("Error querying target features:", error);
            });
          }
        });
    </script>
</body>
</html>

