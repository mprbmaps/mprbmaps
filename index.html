<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew Leader Dashboard</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
    body {
    font-family: Avenir Next, sans-serif;
    display: flex;
}
#crewLeaderContainer {
    width: 240px;
    height: 100vh;
    overflow-y: auto;
    background-color: #f0f0f0;
    padding: 10px;
    position: fixed;
    left: 0;
    top: 0;
    border: 1px solid #005a8b;
    border-radius: 4px;
    
}
#serviceAreaContainer {
    margin-left: 260px; /* This is the width of the #crewLeaderContainer plus padding */
    padding-left: 40px; /* Optional: Adds padding inside the container for better spacing */
    padding-right: 20px; /* Optional: Adds padding inside the container for better spacing */
    overflow-y: auto;
    height: 100vh;
    width: auto; /* Allows the container to take the necessary width */
    box-sizing: border-box; /* Ensures padding is included in the width */
}

.crew-leader {
    margin: 10px 0 5px 40px; /* Indentation specifically for crew-leader tiles */
    padding: 10px;
    background-color: #0079c1;
    color: white;
    border: 1px solid #005a8b;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    display: block; /* Ensure block-level display for correct margin application */
}
.park {
    margin: 5px 0;
    padding: 10px;
    background-color: darkgreen; /* Specific styling for park name tiles */
    color: white;
    font-weight: bold;
    border: 1px solid #005a8b;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    display: block; /* Ensure block-level display */
}
.service-area {
    margin: 10px 0; /* Adjusted margin for clarity and consistency */
    padding: 10px;
    background-color: #f3f3f3;
    border: 1px solid #ccc;
    border-radius: 4px;
}
.park-and-leaders-container {
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    max-width: 400px; /* Consistent max-width for alignment */
    margin-left: auto; /* Center alignment if needed */
    margin-right: auto; /* Center alignment if needed */
}
.service-area-name, .plus-icon {
    font-weight: bold;
    cursor: pointer;
}
.service-area-content {
    display: none; /* Initially hide the content */
}
.expand-collapse-icon {
    display: inline-block;
    margin-right: 5px;
}
.service-area-name {
    display: inline-block;
}

</style>
</head>
<body>
<div id="crewLeaderContainer"></div>
<div id="serviceAreaContainer"></div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
    require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager",
    "esri/layers/FeatureLayer",
    "esri/rest/support/Query"
], function(OAuthInfo, esriId, FeatureLayer, Query) {
    var info = new OAuthInfo({
        appId: "ti3fi1fqvhe2hhyw",
        popup: false
    });
    esriId.registerOAuthInfos([info]);

    var expandedServiceAreas = {}; // Track expanded service areas

    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
        loadCrewLeaders();
    }).catch(function() {
        esriId.getCredential(info.portalUrl + "/sharing");
    });

    function loadCrewLeaders() {
        var layer = new FeatureLayer({
            url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/CrewleaderAssignments/FeatureServer/0"
        });

        var query = layer.createQuery();
        query.where = "1=1";
        query.outFields = ["Name_Primary", "ASMCrewLeader", "ASMCrewLeaderPhone", "ASMCrewLeaderEmail", "Maintenance_SA", "OBJECTID"];
        query.returnGeometry = false;
        layer.queryFeatures(query).then(function(response) {
            processFeatures(response.features);
        });
    }

    function processFeatures(features) {
        const serviceAreasMap = {};
        const crewLeaders = new Map(); // Use Map to store crew leaders and their IDs

        features.forEach(feature => {
            const { Maintenance_SA, Name_Primary, ASMCrewLeader, OBJECTID } = feature.attributes;

            if (ASMCrewLeader) {
                crewLeaders.set(OBJECTID, ASMCrewLeader); // Map OBJECTID to crew leader name
            }

            if (!serviceAreasMap[Maintenance_SA]) {
                serviceAreasMap[Maintenance_SA] = {};
            }

            const parkNames = Name_Primary.split('"').filter(parkName => parkName.trim().length > 0);
            parkNames.forEach(parkName => {
                parkName = parkName.trim();
                if (!serviceAreasMap[Maintenance_SA][parkName]) {
                    serviceAreasMap[Maintenance_SA][parkName] = new Set();
                }
                serviceAreasMap[Maintenance_SA][parkName].add(OBJECTID); // Associate OBJECTID with park
            });
        });

        populatePeople(crewLeaders);
        populateServiceAreas(serviceAreasMap, crewLeaders);
    }

    function populatePeople(crewLeaders) {
        const container = document.getElementById('crewLeaderContainer');
        container.innerHTML = '';

        Array.from(crewLeaders.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, name]) => {
            const leaderDiv = document.createElement('div');
            leaderDiv.className = 'crew-leader';
            leaderDiv.textContent = name;
            leaderDiv.setAttribute('draggable', true);
            leaderDiv.setAttribute('data-objectid', id);
            leaderDiv.addEventListener('dragstart', handleDragStart);
            container.appendChild(leaderDiv);
        });
    }

    function handleDragStart(event) {
        event.dataTransfer.setData("text/plain", event.target.getAttribute('data-objectid'));
    }

    function handleDrop(event, crewLeaders, serviceAreasMap, area, parkName) {
    event.preventDefault();
    const objectID = event.dataTransfer.getData("text/plain");
    const newCrewLeaderName = crewLeaders.get(parseInt(objectID));

    if (!newCrewLeaderName) return;

    // Find the park container where the drop happened
    const parkContainer = event.target.closest('.park-and-leaders-container');

    // Check if the drop target is a crew leader tile within the park
    const isDropOnCrewLeader = event.target.classList.contains('crew-leader');

    // Replace or add the crew leader tile
    if (isDropOnCrewLeader || parkContainer) {
        // Find existing crew leader tile if present
        const existingLeaderTile = parkContainer.querySelector('.crew-leader');

        if (existingLeaderTile) {
            // Replace existing crew leader name and ID
            existingLeaderTile.textContent = newCrewLeaderName;
            existingLeaderTile.setAttribute('data-objectid', objectID);
        } else {
            // If no existing crew leader, add a new tile
            const leaderTile = document.createElement('div');
            leaderTile.className = 'crew-leader';
            leaderTile.textContent = newCrewLeaderName;
            leaderTile.setAttribute('data-objectid', objectID);
            leaderTile.setAttribute('draggable', true);
            leaderTile.addEventListener('dragstart', handleDragStart);
            parkContainer.appendChild(leaderTile);
        }

        // Update the internal model to reflect the new crew leader
        // First, remove any existing assignment
        Object.values(serviceAreasMap).forEach(parks => {
            Object.keys(parks).forEach(park => {
                if (parks[park] instanceof Set) {
                    parks[park].delete(parseInt(objectID)); // Remove the new crew leader from any other park
                }
            });
        });

        // Assign the new crew leader to the current park
        serviceAreasMap[area][parkName] = new Set([parseInt(objectID)]);
    }

    // Refresh the UI here if needed to reflect other changes
}


    function populateServiceAreas(serviceAreasMap, crewLeaders) {
        const container = document.getElementById('serviceAreaContainer');
        container.innerHTML = ''; // Clear existing content

        Object.entries(serviceAreasMap).sort((a, b) => a[0].localeCompare(b[0])).forEach(([area, parks]) => {
            const areaDiv = document.createElement('div');
            areaDiv.className = 'service-area';

            const nameContainerDiv = document.createElement('div');
            nameContainerDiv.className = 'name-container';

            const expandCollapseIcon = document.createElement('span');
            expandCollapseIcon.className = 'expand-collapse-icon';
            expandCollapseIcon.textContent = expandedServiceAreas[area] ? '▼' : '▶';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'service-area-name';
            nameDiv.textContent = area;

            nameContainerDiv.appendChild(expandCollapseIcon);
            nameContainerDiv.appendChild(nameDiv);

            areaDiv.appendChild(nameContainerDiv);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'service-area-content';
            contentDiv.style.display = expandedServiceAreas[area] ? 'block' : 'none';
            areaDiv.appendChild(contentDiv);

            Object.entries(parks).sort((a, b) => a[0].localeCompare(b[0])).forEach(([parkName, crewLeaderIds]) => {
                const parkAndLeadersContainer = document.createElement('div');
                parkAndLeadersContainer.className = 'park-and-leaders-container';
                parkAndLeadersContainer.addEventListener('dragover', event => event.preventDefault());
                parkAndLeadersContainer.addEventListener('drop', event => handleDrop(event, crewLeaders, serviceAreasMap, area, parkName));

                const parkDiv = document.createElement('div');
                parkDiv.className = 'park';
                parkDiv.textContent = parkName;
                parkAndLeadersContainer.appendChild(parkDiv);

                crewLeaderIds.forEach(objectId => {
                    const leaderName = crewLeaders.get(objectId);
                    if (leaderName) {
                        const leaderTile = document.createElement('div');
                        leaderTile.className = 'crew-leader';
                        leaderTile.textContent = leaderName;
                        leaderTile.setAttribute('data-objectid', objectId);
                        parkAndLeadersContainer.appendChild(leaderTile);
                    }
                });

                contentDiv.appendChild(parkAndLeadersContainer);
            });

            expandCollapseIcon.addEventListener('click', function() {
                const isExpanded = contentDiv.style.display === 'block';
                contentDiv.style.display = isExpanded ? 'none' : 'block';
                expandCollapseIcon.textContent = isExpanded ? '▶' : '▼';
                expandedServiceAreas[area] = !expandedServiceAreas[area]; // Toggle expanded state
            });

            container.appendChild(areaDiv);
        });
    }
});

</script>
</body>
</html>
