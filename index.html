<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minneapolis Park & Rec Board - Citizen Report Tool</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        body, html {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #viewDiv {
            height: 100%;
            width: 70%;
            float: left;
        }
        .form-container {
            position: fixed;
            background-color: #fff;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            box-sizing: border-box;
            bottom: 100px;
            right: 0;
            width: 30%;
            height: 50%;
        }
        .form-cell {
            position: relative;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: -1px;
            height: 75px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .form-cell.disabled {
            background-color: #f0f0f0;
        }
        .form-cell label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
        }
        .form-cell select, .form-cell button, .form-cell input[type="file"] {
            width: 80%;
            padding: 10px;
            margin-top: 30px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .step-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #ddd; /* Default gray color */
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        @media screen and (max-width: 768px) {
            #viewDiv {
                width: 100%;
                height: 40%;
            }
            .form-container {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60%;
            }
        }
        @media screen and (min-width: 769px) {
            .form-container {
                width: 30%;
                height: 100%;
                position: fixed;
                right: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    <div class="form-container">
        <div class="form-cell" id="cell1">
            <label>Location (click on the map):</label>
            <div class="step-icon">1</div>
        </div>
        <div class="form-cell disabled" id="cell2">
            <label>Select Issue Type</label>
            <div class="step-icon">2</div>
            <select id="issueType" name="issueType" onchange="checkIssueType()" disabled>
                <option value="Pothole">Pothole</option>
                <option value="Streetlight">Streetlight</option>
                <option value="Vandalism">Vandalism</option>
                <option value="Litter">Litter</option>
            </select>
        </div>
        <div class="form-cell disabled" id="cell3">
            <label>Photo (optional):</label>
            <div class="step-icon">3</div>
            <input type="file" id="photoUpload" name="photo" disabled>
        </div>
        <div class="form-cell disabled" id="cell4">
            <label>Submit Report</label>
            <div class="step-icon">4</div>
            <button type="submit" id="submitReport" disabled>Submit Report</button>
        </div>
    </div>
    <script>
        var currentCellIndex = 1; // Variable to track the current active cell index
        var pointGraphic;

        function enableCell(cellId) {
            var cell = document.getElementById(cellId);
            cell.classList.remove('disabled');
            var label = cell.querySelector('label');
            if (label) {
                label.style.color = '#333'; // Set heading text color to black
            }
            var stepIcon = cell.querySelector('.step-icon');
            if (stepIcon) {
                stepIcon.style.backgroundColor = '#24811B'; // Set green color when enabled
            }
            currentCellIndex++;

            // Enable dropdown if cell 2 is enabled
            if (cellId === 'cell2') {
                var issueTypeDropdown = document.getElementById('issueType');
                issueTypeDropdown.disabled = false;
            } else if (cellId === 'cell3') {
                var fileUpload = document.getElementById('photoUpload');
                fileUpload.disabled = false; // Enable file input
            } else if (cellId === 'cell4') {
                var submitButton = document.getElementById('submitReport');
                submitButton.disabled = false; // Enable submit button
            }
        }

        function disableCell(cellId) {
            var cell = document.getElementById(cellId);
            if (cell) {
                cell.classList.remove('enabled'); // Remove 'enabled' class to revert to default background color
                cell.classList.add('disabled');
                var label = cell.querySelector('label');
                if (label) {
                    label.style.color = '#999'; // Set heading text color to gray
                }
                var stepIcon = cell.querySelector('.step-icon');
                if (stepIcon) {
                    stepIcon.style.backgroundColor = '#ddd'; // Default gray color when disabled
                }
            }
        }

        function checkIssueType() {
            var issueType = document.getElementById('issueType').value;
            if (issueType !== 'Pothole') {
                disableCell('cell2');
                enableCell('cell3');
                enableCell('cell4');
            }
        }

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/widgets/Locate",
            "esri/geometry/Point",
            "esri/symbols/PictureMarkerSymbol",
            "esri/layers/FeatureLayer",
            "esri/rest/support/Query"
        ], function(Map, MapView, Graphic, GraphicsLayer, Locate, Point, PictureMarkerSymbol, FeatureLayer, Query) {
            var map = new Map({
                basemap: "streets-navigation-vector"
            });

            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-93.2650, 44.9778], // Center on Minneapolis
                zoom: 12
            });

            var graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);

            var locateWidget = new Locate({
                view: view,
                rotationEnabled: false // Correct property for disabling map rotation
            });

            view.ui.add(locateWidget, "top-left");

            view.when().then(function() {
                locateWidget.locate().catch(function(error) {
                    console.error("Locate widget error:", error.message);
                    // Optionally handle the error, e.g., display a message to the user
                });

                // Define the FeatureLayer with the correct URL
                var featureLayer = new FeatureLayer({
                    url: "https://gis.minneapolisparks.org/arcgisprod/rest/services/Services/MPRB_PublicLayers/MapServer/0"
                });

                var pointGraphic; // Define pointGraphic variable outside to keep track of the graphic

                view.on("click", function(event) {
                    // Remove previous location graphic
                    if (pointGraphic) {
                        graphicsLayer.remove(pointGraphic);
                    }

                    // Query the feature layer
                    var query = featureLayer.createQuery();
                    query.geometry = event.mapPoint; // Use the point directly
                    query.spatialRelationship = "intersects";
                    query.outFields = ["*"];
                    query.returnGeometry = true;

                    featureLayer.queryFeatures(query).then(function(result) {
                        console.log("Query results:", result);
                        if (result.features.length > 0) {
                            disableCell('cell1'); // Disable cell 1 when location is selected
                            enableCell('cell2'); // Enable cell 2 when location is selected

                            // Display a graphic at the clicked location using a custom image
                            pointGraphic = new Graphic({
                                geometry: event.mapPoint,
                                symbol: new PictureMarkerSymbol({
                                    url: "https://i.ibb.co/j6ZWfnW/map-location-marker.png",
                                    width: "36px",
                                    height: "36px"
                                })
                            });
                            graphicsLayer.add(pointGraphic); // Add new location graphic
                        } else {
                            // If no location is found, reset the cells
                            enableCell('cell1'); // Enable cell 1 again
                            disableCell('cell2'); // Disable cell 2
                            disableCell('cell3'); // Disable cell 3
                            disableCell('cell4'); // Disable cell 4
                            var issueTypeDropdown = document.getElementById('issueType');
                            issueTypeDropdown.disabled = true; // Disable the dropdown
                            alert("Location is not within MPRB's Responsibility");
                        }
                    }).catch(function(error) {
                        console.error("Error querying features:", error);
                    });
                });

                // Initial setup: disable cells 2, 3, and 4
                disableCell('cell2');
                disableCell('cell3');
                disableCell('cell4');
            });
        });
    </script>
</body>
</html>
