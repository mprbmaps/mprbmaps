<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Feature and Related Inspections with Attachments</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.23/"></script>
    <style>
        html, body, #viewDiv {
            height: 100%;
            width: 75%;
            margin: 0;
            padding: 0;
        }
        #sidePanel {
            width: 25%;
            height: 100%;
            position: fixed;
            top: 0;
            right: 0;
            overflow-y: auto;
            background-color: #fff;
            border-left: 1px solid #ddd;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    <div id="sidePanel">
        <h3>Attachments</h3>
        <div id="attachments"></div>
    </div>

    <script>
        require([
            "esri/config",
            "esri/identity/OAuthInfo",
            "esri/identity/IdentityManager",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/rest/support/RelationshipQuery",
            "esri/Graphic",
            "esri/symbols/SimpleFillSymbol",
        ], function(esriConfig, OAuthInfo, IdentityManager, Map, MapView, FeatureLayer, RelationshipQuery, Graphic, SimpleFillSymbol) {

            esriConfig.portalUrl = "https://www.arcgis.com";

            var oauthInfo = new OAuthInfo({
                appId: "ti3fi1FqvHE2Hhyw",
                popup: true
            });

            IdentityManager.registerOAuthInfos([oauthInfo]);

            IdentityManager.checkSignInStatus(esriConfig.portalUrl + "/sharing")
                .then(function() {
                    console.log("Signed in successfully");
                    loadMap();
                })
                .catch(function() {
                    IdentityManager.getCredential(esriConfig.portalUrl + "/sharing");
                });

            function loadMap() {
                var featureLayer = new FeatureLayer({
                    url: "https://gis.minneapolisparks.org/arcgisprod/rest/services/Asssets2/FeatureServer/40"
                });

                var inspectionLayer = new FeatureLayer({
                    url: "https://gis.minneapolisparks.org/arcgisprod/rest/services/Asssets2/FeatureServer/43"
                });

                var map = new Map({
                    basemap: "streets-navigation-vector",
                    layers: [featureLayer]
                });

                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 10,
                    center: [-93.2650, 44.9778]
                });

                var highlightSymbol = new SimpleFillSymbol({
                    color: [255, 255, 0, 0.4],
                    outline: {
                        color: [255, 255, 0],
                        width: 2
                    }
                });

                view.on("click", function(event) {
                    view.hitTest(event).then(function(response) {
                        var results = response.results.filter(function(result) {
                            return result.graphic.layer === featureLayer;
                        });

                        if (results.length) {
                            var feature = results[0].graphic;
                            var highlightGraphic = new Graphic({
                                geometry: feature.geometry,
                                symbol: highlightSymbol
                            });
                            view.graphics.removeAll();
                            view.graphics.add(highlightGraphic);
                            queryRelatedAttachments(feature.attributes.OBJECTID);
                        }
                    });
                });

                function queryRelatedAttachments(objectId) {
                    var relationshipQuery = new RelationshipQuery({
                        objectIds: [objectId],
                        relationshipId: 16, // Replace 0 with the actual relationship ID
                        outFields: ["*"],
                        returnGeometry: false
                    });

                    featureLayer.queryRelatedFeatures(relationshipQuery).then(function(relatedRecords) {
                        var relatedObjectIds = [];
                        Object.values(relatedRecords).forEach(function(record) {
                            record.features.forEach(function(feature) {
                                relatedObjectIds.push(feature.attributes.OBJECTID);
                            });
                        });

                        if (relatedObjectIds.length > 0) {
                            inspectionLayer.queryAttachments({
                                objectIds: relatedObjectIds,
                                attachmentTypes: ['image/jpeg', 'image/png']
                            }).then(function(attachmentInfos) {
                                displayAttachments(attachmentInfos);
                            }).catch(function(error) {
                                console.error("Error querying attachments: ", error);
                            });
                        }else {
                            document.getElementById("attachments").innerHTML = "No related records found.";
                        }
                    }).catch(function(error) {
                        console.error("Error querying related features: ", error);
                    });
                }

                function displayAttachments(attachmentInfos) {
                    var attachmentsDiv = document.getElementById("attachments");
                    attachmentsDiv.innerHTML = ""; // Clear previous attachments
                    
                    Object.values(attachmentInfos).forEach(function(infoArray) {
                        infoArray.forEach(function(info) {
                            var link = document.createElement("a");
                            link.href = info.url;
                            link.target = "_blank";
                            var image = document.createElement("img");
                            image.src = info.url;
                            image.style.width = "100%";
                            image.style.padding = "4px";
                            link.appendChild(image);
                            attachmentsDiv.appendChild(link);
                        });
                    });

                    if (Object.keys(attachmentInfos).length === 0) {
                        attachmentsDiv.innerHTML = "No attachments found.";
                    }
                }
            }
        });
    </script>
</body>
</html>
