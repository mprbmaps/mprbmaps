<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArcGIS Feature Inspection</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.22/"></script>
  <script src="https://js.arcgis.com/4.22/esri/modules/identity/OAuthInfo.js"></script>
  <script src="https://js.arcgis.com/4.22/esri/modules/identity/IdentityManager.js"></script>
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
    }

    #viewDiv {
      height: 100%;
      width: 100%;
    }

    #sidePanel {
      height: 100%;
      width: 0;
      position: fixed;
      top: 0;
      right: 0;
      padding: 20px;
      box-sizing: border-box;
      overflow-x: hidden;
      background-color: #f8f9fa;
      border-left: 1px solid #ced4da;
      transition: 0.5s;
      visibility: hidden; /* Initially hidden */
    }

    #inspectionForm {
      margin-bottom: 20px;
    }

    #sidePanel h2 {
      color: #007bff;
    }

    #sidePanel label {
      display: block;
      margin: 10px 0;
    }

    #sidePanel input,
    #sidePanel select {
      width: calc(100% - 20px);
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }

    #sidePanel button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }

    #clearSelection {
      background-color: #dc3545;
      margin-top: 10px;
    }

    #inspectionTable {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    #inspectionTable th,
    #inspectionTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    #inspectionTable th {
      background-color: #f2f2f2;
    }

    #priorInspectionsTable {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    #priorInspectionsTable th,
    #priorInspectionsTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    #priorInspectionsTable th {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="sidePanel">
    <h2>Feature Inspection</h2>
    <form id="inspectionForm">
      <label for="inspectionDate">Inspection Date:</label>
      <input type="date" id="inspectionDate" name="inspectionDate" required>

      <label for="conditionScore">Condition Score:</label>
      <select id="conditionScore" name="conditionScore" required>
        <option value="">Select...</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>

      <label for="requiresMaintenance">Requires Maintenance:</label>
      <select id="requiresMaintenance" name="requiresMaintenance" required>
        <option value="">Select...</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <button type="button" id="submitBtn">Submit</button>
      <button type="button" id="clearSelection">Clear Selection</button>
    </form>
    
    <table id="priorInspectionsTable">
      <thead>
        <tr>
          <th>Prior Inspection Date</th>
          <th>Prior Condition Score</th>
          <th>Prior Requires Maintenance</th>
        </tr>
      </thead>
      
    </table>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/widgets/Popup",
      "esri/tasks/QueryTask",
      "esri/tasks/support/Query",
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager",
      "dojo/domReady!"
    ], function (Map, MapView, FeatureLayer, Graphic, SimpleMarkerSymbol, Popup, QueryTask, Query, OAuthInfo, esriId) {

      // OAuth configuration
      const oAuthInfo = new OAuthInfo({
        appId: "ti3fi1FqvHE2Hhyw",
        portalUrl: "https://www.arcgis.com"
      });

      esriId.registerOAuthInfos([oAuthInfo]);

      // Check if the user is already signed in
      esriId.checkSignInStatus(oAuthInfo.portalUrl + "/sharing").then(
        function () {
          // User is already signed in, continue with application
          initializeMap();
        }
      ).otherwise(
        function () {
          // User is not signed in, initiate sign-in process
          esriId.getCredential(oAuthInfo.portalUrl + "/sharing");
        }
      );

      function initializeMap() {
        // Map initialization code
        const map = new Map({
          basemap: {
            portalItem: {
              id: "a11d663a981947b99aac7ff05437758f"
            }
          }
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-93.2650, 44.9778],
          zoom: 12
        });

        const featureLayer = new FeatureLayer({
          url: featureLayerUrl
        });

        const inspectionLayer = new FeatureLayer({
          url: inspectionLayerUrl,
          outFields: ["*"]
        });

        map.add(featureLayer);
        map.add(inspectionLayer);

        const selectedFeatures = [];
        const selectionGraphics = [];

        view.on("click", function (event) {
          view.hitTest(event).then(function (response) {
            const result = response.results && response.results[0];

            if (result && result.graphic && result.graphic.layer === featureLayer) {
              const graphic = result.graphic;

              selectedFeatures.push(graphic);

              const symbol = new SimpleMarkerSymbol({
                color: [0, 255, 0],
                size: 10,

                // Visualize selected feature
              const symbol = new SimpleMarkerSymbol({
                color: [0, 255, 0], // Green color
                size: 10,
                outline: {
                  color: [0, 0, 0],
                  width: 2
                }
              });

              const selectionGraphic = new Graphic({
                geometry: graphic.geometry,
                symbol: symbol
              });

              selectionGraphics.push(selectionGraphic);

              // Clear previous selection graphics
              view.graphics.removeAll();

              // Add the new selection graphics
              view.graphics.addMany(selectionGraphics);

              // Center the map on the selected feature and set zoom level to 15
              view.goTo({
                target: graphic.geometry,
                zoom: 17
              });

              // Show the side panel
              showSidePanel();
            } else {
              console.warn("No valid graphic found during hitTest.");
            }
          }).catch(error => {
            console.error("Error during hitTest:", error);
          });
        });

        document.getElementById("submitBtn").onclick = function () {
          const inspectionDate = document.getElementById("inspectionDate").value;
          const conditionScore = document.getElementById("conditionScore").value;
          const requiresMaintenance = document.getElementById("requiresMaintenance").value;

          if (!inspectionDate || !conditionScore || !requiresMaintenance) {
            alert("Please fill out all required fields.");
            return;
          }

          selectedFeatures.forEach(selectedFeature => {
            featureLayer.queryFeatures({
              objectIds: [selectedFeature.attributes.OBJECTID],
              outFields: ["*"]
            }).then(function (featureSet) {
              const selectedFeatureAttributes = featureSet.features[0].attributes;

              const newFeature = new Graphic({
                geometry: selectedFeature.geometry,
                attributes: {
                  inspection_date: inspectionDate,
                  condition_score: conditionScore,
                  requires_maintenance: requiresMaintenance,
                  relfeatureglobalid: selectedFeatureAttributes.GlobalID
                }
              });

              inspectionLayer.applyEdits({
                addFeatures: [newFeature]
              }).then(function (editsResult) {
                console.log("Feature added successfully:", editsResult);
                document.getElementById("inspectionForm").reset();
                hideSidePanel();
                populateInspectionTable(selectedFeatureAttributes.GlobalID);
                populatePriorInspections(selectedFeatureAttributes.GlobalID);
              }).catch(function (error) {
                console.error("Error adding feature:", error);
              });
            }).catch(function (error) {
              console.error("Error querying selected feature:", error);
            });
          });

          view.graphics.removeAll();
          selectedFeatures.length = 0;
          selectionGraphics.forEach(graphic => {
            graphic.geometry = null;
          });
          selectionGraphics.length = 0;

          view.popup.autoOpenEnabled = false;
        };

        document.getElementById("clearSelection").onclick = function () {
          view.graphics.removeAll();
          selectedFeatures.length = 0;
          selectionGraphics.forEach(graphic => {
            graphic.geometry = null;
          });
          selectionGraphics.length = 0;
          hideSidePanel();
          view.popup.autoOpenEnabled = true;
        };

        function showSidePanel() {
          document.getElementById("sidePanel").style.width = "30%";
          document.getElementById("sidePanel").style.visibility = "visible";
          document.getElementById("viewDiv").style.width = "70%";
        }

        function hideSidePanel() {
          document.getElementById("sidePanel").style.width = "0";
          document.getElementById("sidePanel").style.visibility = "hidden";
          document.getElementById("viewDiv").style.width = "100%";
        }

        function populateInspectionTable(selectedFeatureGlobalID) {
          const queryTask = new QueryTask({
            url: inspectionLayerUrl
          });

          const query = new Query({
            outFields: ["inspection_date", "condition_score", "requires_maintenance"],
            orderByFields: ["inspection_date DESC"],
            returnGeometry: false,
            where: `relfeatureglobalid = '${selectedFeatureGlobalID}'`
          });

          queryTask.execute(query).then(function (results) {
            const tbody = document.querySelector("#inspectionTable tbody");
            tbody.innerHTML = "";

            results.features.forEach(function (feature) {
              const attributes = feature.attributes;
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${attributes.inspection_date}</td>
                <td>${attributes.condition_score}</td>
                <td>${attributes.requires_maintenance}</td>
              `;
              tbody.appendChild(row);
            });
          }).catch(function (error) {
            console.error("Error querying inspection records:", error);
          });
        }

        function populatePriorInspections(selectedFeatureGlobalID) {
          const queryTask = new QueryTask({
            url: inspectionLayerUrl
          });

          const query = new Query({
            outFields: ["inspection_date", "condition_score", "requires_maintenance"],
            orderByFields: ["inspection_date DESC"],
            returnGeometry: false,
            where: `relfeatureglobalid = '${selectedFeatureGlobalID}' AND inspection_date < current_timestamp`
          });

          queryTask.execute(query).then(function (results) {
            const tbody = document.querySelector("#priorInspectionsTable tbody");
            tbody.innerHTML = "";

            results.features.forEach(function (feature) {
              const attributes = feature.attributes;
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${attributes.inspection_date}</td>
                <td>${attributes.condition_score}</td>
                <td>${attributes.requires_maintenance}</td>
              `;
              tbody.appendChild(row);
            });
          }).catch(function (error) {
            console.error("Error querying prior inspection records:", error);
          });
        }

      }

    });
  </script>
</body>

</html>
