<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Update Feature Layer Fields</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css">
    <style>
        html, body, #viewDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #updateButton {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 99;
            background-color: #fff;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="updateButton">Update Plowing Hours</div>
    <div id="viewDiv"></div>

    <script src="https://js.arcgis.com/4.23/"></script>
    <script>
        require([
          "esri/config",
          "esri/Map",
          "esri/views/MapView",
          "esri/layers/FeatureLayer",
          "esri/request",
          "esri/identity/OAuthInfo",
          "esri/identity/IdentityManager"
        ], function(esriConfig, Map, MapView, FeatureLayer, esriRequest, OAuthInfo, esriId) {

          console.log("Modules loaded.");

          const oauthInfo = new OAuthInfo({
            appId: "ti3fi1FqvHE2Hhyw",
            popup: true
          });
          esriId.registerOAuthInfos([oauthInfo]);

          console.log("OAuthInfo registered.");

          esriId.checkSignInStatus(oauthInfo.portalUrl + "/sharing").then(
            function() {
              console.log("Signed in successfully.");
              initApp();
            }
          ).catch(function() {
              console.log("Not signed in, prompting for sign-in.");
              esriId.getCredential(oauthInfo.portalUrl + "/sharing");
          });

          function initApp() {
            console.log("Initializing application...");

            const map = new Map({
              basemap: "arcgis-topographic"
            });

            const view = new MapView({
              container: "viewDiv",
              map: map,
              zoom: 10,
              center: [-100, 40]
            });

            console.log("Map and view created.");

            const snowRoutesLayer = new FeatureLayer({
              url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/SnowRoutes_9d4babee9d65431ebe5027eb4b6ea135/FeatureServer"
            });
            map.add(snowRoutesLayer);

            console.log("Feature layer added to the map.");

            document.getElementById("updateButton").addEventListener("click", function() {
              console.log("Update button clicked.");
              fetchSourceDataAndUpdateLayer(snowRoutesLayer);
            });
          }

          function fetchSourceDataAndUpdateLayer(snowRoutesLayer) {
            console.log("Fetching source data...");

            const sourceTableUrl = "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/segment_time_to_reach_snowroute/FeatureServer/0/query";
            
            esriRequest(sourceTableUrl, {
              query: {
                where: "1=1",
                outFields: "*",
                f: "json"
              },
              responseType: "json"
            }).then(function(sourceResponse) {
              console.log("Source data fetched successfully.");

              const sourceFeatures = sourceResponse.data.features;
              
              const query = snowRoutesLayer.createQuery();
              query.where = "1=1";
              query.outFields = ["OBJECTID", "snowroutesegmentid"];

              snowRoutesLayer.queryFeatures(query).then(function(targetResponse) {
                console.log("Target layer features fetched for matching.");

                const targetFeatures = targetResponse.features;
                
                const updates = prepareUpdates(sourceFeatures, targetFeatures);

                console.log(`Prepared ${updates.length} updates.`);

                if (updates.length > 0) {
                  snowRoutesLayer.applyEdits({
                    updateFeatures: updates
                  }).then(function(results) {
                    console.log("Successfully updated features:", results);
                  }).catch(function(error) {
                    console.error("Error applying updates:", error);
                  });
                } else {
                  console.log("No matching features found to update.");
                }
              });
            }).catch(function(error) {
              console.error("Error fetching source data:", error);
            });
          }

          function prepareUpdates(sourceFeatures, targetFeatures) {
            console.log("Preparing updates...");

            return sourceFeatures.map(sourceFeature => {
              const matchedTargetFeature = targetFeatures.find(targetFeature => 
                targetFeature.attributes.snowroutesegmentid === sourceFeature.attributes.segmentID);

              if (matchedTargetFeature) {
                console.log(`Match found for segmentID: ${sourceFeature.attributes.segmentID}`);
                return {
                  attributes: {
                    OBJECTID: matchedTargetFeature.attributes.OBJECTID,
                    Hrs21stPlow_2024_2: sourceFeature.attributes.hours
                  }
                };
              } else {
                console.log(`No match found for segmentID: ${sourceFeature.attributes.segmentID}`);
                return null;
              }
            }).filter(update => update !== null);
          }

        });
    </script>
</body>
</html>
