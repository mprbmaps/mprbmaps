<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew Leader Dashboard</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        body {
            font-family: Avenir Next, sans-serif;
            display: flex;
        }
        #crewLeaderContainer {
            width: 200px;
            height: 100vh;
            overflow-y: auto;
            background-color: #f0f0f0;
            padding: 10px;
        }
        .crew-leader {
            margin: 5px 0;
            padding: 10px;
            background-color: #0079c1;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }
        #serviceAreaContainer {
            flex-grow: 1;
            padding: 10px;
        }
        .service-area, .park {
            margin: 10px;
            padding: 10px;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .service-area-name, .plus-icon {
            font-weight: bold;
            cursor: pointer;
        }
        .service-area-content, .park {
            display: none; /* Initially hide the content */
        }
    </style>
</head>
<body>
<div id="crewLeaderContainer"></div>
<div id="serviceAreaContainer"></div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager",
    "esri/layers/FeatureLayer",
    "esri/rest/support/Query"
], function(OAuthInfo, esriId, FeatureLayer, Query) {
    // Initialize OAuth with your app's specific details
    var info = new OAuthInfo({
        appId: "ti3fi1FqvHE2Hhyw", // Replace with your actual App ID
        popup: false // Using the redirect pattern for OAuth
    });
    esriId.registerOAuthInfos([info]);

    // Check if the user is already signed in
    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
        // Proceed to load and display the data
        loadCrewLeaders();
    }).catch(function() {
        // If not signed in, prompt the user to sign in
        esriId.getCredential(info.portalUrl + "/sharing");
    });

    // Function to load crew leaders from the FeatureLayer
    function loadCrewLeaders() {
        // Define the FeatureLayer you are working with
        var layer = new FeatureLayer({
            url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/CrewleaderAssignments/FeatureServer/0"
        });

        // Create a query to fetch all features with all fields
        var query = layer.createQuery();
        query.where = "1=1";
        query.outFields = ["*"];
        query.returnGeometry = false;

        // Execute the query
        layer.queryFeatures(query).then(function(response) {
            // Process the features returned by the query
            processFeatures(response.features);
        });
    }

    // Function to process features and organize data for UI population
    function processFeatures(features) {
        const serviceAreasMap = {};

        features.forEach(feature => {
            const { Maintenance_SA, Name_Primary, ASMCrewLeader } = feature.attributes;

            // Initialize the service area entry if it doesn't exist
            if (!serviceAreasMap[Maintenance_SA]) {
                serviceAreasMap[Maintenance_SA] = { parks: [], crewLeaders: new Set() };
            }
            
            // Split the Name_Primary field to get individual park names
            // Assuming park names are separated by ";"
            const parkNames = Name_Primary.split(";").map(name => name.trim());
            parkNames.forEach(parkName => {
                if (parkName) serviceAreasMap[Maintenance_SA].parks.push(parkName);
            });

            // Add the crew leader to the set of crew leaders for the service area
            serviceAreasMap[Maintenance_SA].crewLeaders.add(ASMCrewLeader);
        });

        // Populate the UI with the organized data
        populateServiceAreas(serviceAreasMap);
    }

    // Function to dynamically create and insert service area and park elements into the DOM
    function populateServiceAreas(serviceAreasMap) {
        const container = document.getElementById('serviceAreaContainer');
        container.innerHTML = ''; // Clear existing content

        Object.entries(serviceAreasMap).forEach(([area, {parks, crewLeaders}]) => {
            // Create the container for the service area
            const areaDiv = document.createElement('div');
            areaDiv.className = 'service-area';
            
            // Create and append the name element for the service area
            const nameDiv = document.createElement('div');
            nameDiv.className = 'service-area-name';
            nameDiv.textContent = area;
            areaDiv.appendChild(nameDiv);

            // Create and append the plus icon for toggling visibility
            const plusIcon = document.createElement('span');
            plusIcon.className = 'plus-icon';
            plusIcon.textContent = '+';
            nameDiv.appendChild(plusIcon);

            // Container for the parks and crew leaders
            const contentDiv = document.createElement('div');
            contentDiv.className = 'service-area-content';
            areaDiv.appendChild(contentDiv);

            // Append each park to the service area
            parks.forEach(parkName => {
                const parkDiv = document.createElement('div');
                parkDiv.className = 'park';
                parkDiv.textContent = parkName;
                contentDiv.appendChild(parkDiv);
            });

            // Append each crew leader to the service area
            crewLeaders.forEach(leaderName => {
                const leaderDiv = document.createElement('div');
                leaderDiv.className = 'crew-leader';
                leaderDiv.textContent = leaderName;
                contentDiv.appendChild(leaderDiv);
            });

            // Add click event listener for toggling the display of the contentDiv
            plusIcon.addEventListener('click', function() {
                const isExpanded = contentDiv.style.display === 'block';
                contentDiv.style.display = isExpanded ? 'none' : 'block';
                plusIcon.textContent = isExpanded ? '+' : '-';
            });

            // Append the service area div to the container
            container.appendChild(areaDiv);
        });
    }
});



</script>
</body>
</html>
