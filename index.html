<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draggable Crew Leader Tiles</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        body {
            font-family: Avenir Next, sans-serif;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
        }
        .crew-leader {
            margin: 10px;
            padding: 10px;
            background: #0079c1;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .service-area {
            margin: 10px;
            padding: 10px;
            background: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .park {
            padding: 5px;
            background: #e7ffe7;
            border: 1px solid #b2ffb2;
            margin-top: 5px;
            border-radius: 4px;
        }
        .service-area-name, .plus-icon {
            font-weight: bold;
            cursor: pointer;
        }
        .service-area-content {
            display: none;
        }
        .no-name-tile {
            display: none;
        }
    </style>
</head>
<body>
<div id="serviceAreaContainer" class="container"></div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager",
    "esri/layers/FeatureLayer",
    "esri/rest/support/Query"
], function(OAuthInfo, esriId, FeatureLayer, Query) {
    // Set up OAuthInfo
    var info = new OAuthInfo({
        appId: "ti3fi1FqvHE2Hhyw",
        popup: false // Set to false to use the redirect OAuth pattern
    });
    esriId.registerOAuthInfos([info]);

    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
        console.log("User is signed in");
        loadCrewLeaders();
    }).catch(function() {
        // Redirects the user to the OAuth sign-in page
        console.log("User is not signed in");
        esriId.getCredential(info.portalUrl + "/sharing");
    });

    function loadCrewLeaders() {
        var queryLayer = new FeatureLayer({
            url: "https://services6.arcgis.com/MU31z9HAakdc3W69/arcgis/rest/services/CrewleaderAssignments/FeatureServer/0"
        });

        var query = new Query();
        query.where = "1=1"; // Fetch all features
        query.outFields = ["*"]; // Get all fields
        query.returnGeometry = false;

        queryLayer.queryFeatures(query).then(function(response) {
            processFeatures(response.features);
        });
    }

    function processFeatures(features) {
        console.log('Processing features');
        const serviceAreasMap = features.reduce((acc, feature) => {
            const {attributes} = feature;
            const { Maintenance_SA, Name_Primary, ASMCrewLeader, ASMCrewLeaderPhone, ASMCrewLeaderEmail, OBJECTID } = attributes;
            if (!acc[Maintenance_SA]) {
                acc[Maintenance_SA] = { parks: {}, crewLeaders: [] };
            }
            Name_Primary.split('"').forEach(parkName => {
                if (!acc[Maintenance_SA].parks[parkName.trim()]) {
                    acc[Maintenance_SA].parks[parkName.trim()] = { name: parkName.trim() };
                }
            });
            acc[Maintenance_SA].crewLeaders.push({
                objectId: OBJECTID,
                name: ASMCrewLeader,
                phone: ASMCrewLeaderPhone,
                email: ASMCrewLeaderEmail,
                park: Name_Primary
            });
            return acc;
        }, {});

        populateUI(serviceAreasMap);
    }

    function populateUI(serviceAreasMap) {
        const serviceAreaContainer = document.getElementById('serviceAreaContainer');
        serviceAreaContainer.innerHTML = '';

        Object.entries(serviceAreasMap).forEach(([areaName, details]) => {
            let areaDiv = document.createElement('div');
            areaDiv.className = 'service-area';
            serviceAreaContainer.appendChild(areaDiv);

            let nameDiv = document.createElement('div');
            nameDiv.textContent = areaName || 'No Name';
            nameDiv.className = areaName ? 'service-area-name' : 'no-name-tile';
            areaDiv.appendChild(nameDiv);

            details.crewLeaders.forEach(crewLeader => {
                let leaderDiv = document.createElement('div');
                leaderDiv.className = 'crew-leader';
                leaderDiv.textContent = crewLeader.name;
                areaDiv.appendChild(leaderDiv);
            });

            Object.values(details.parks).forEach(park => {
                let parkDiv = document.createElement('div');
                parkDiv.className = 'park';
                parkDiv.textContent = park.name;
                areaDiv.appendChild(parkDiv);
            });
        });
    }

    // You might want to add the drag and drop functionality here
});
</script>
</body>
</html>
