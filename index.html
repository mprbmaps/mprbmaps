<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Display Related Inspections on Feature Selection</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
    <style>
        html, body, #mapContainer, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #mapContainer {
            position: relative;
        }

        #sidePanel {
            position: fixed;
            top: 0;
            right: 0; /* Changed to always be open */
            width: 330px;
            height: 100%;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            overflow-y: auto; /* Allow vertical scrolling */
        }

        #addInspectionForm {
            margin-bottom: 20px;
        }

        #infoDiv {
            flex-grow: 1;
            overflow-y: auto;
        }

        #infoTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #infoTable th, #infoTable td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #infoTable th {
            background-color: #f2f2f2;
        }

        #clearSelectionButton, #submitInspectionButton {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0px;
            width: calc(50% - 5px);
        }

        #clearSelectionButton:hover, #submitInspectionButton:hover {
            background-color: #0056b3;
        }

        select, input[type="date"] {
            width: calc(100% - 12px);
            padding: 5px;
        }

        #successMessage {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
        }

        #inspectionsTitle {
            font-size: 20;
            font-weight: bold;
            margin-top: 10px;
        }

        .line-separator {
            border-top: 1px solid #ccc;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        #filterButton {
            background-color: #007BFF;
            color: white;
            border: solid;
            border-width: .5px;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0px;
            position: absolute;
            top: 20px;
            right: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Add a shadow effect */
        }

        #filterButton:hover {
            background-color: #0056b3;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.7); /* Adjust the shadow on hover */
        }

        #detailedInspection {
            margin-top: 10px; /* Adjusted margin-top */
            display: none; /* Hide Detailed Inspection Info initially */
            overflow-y: auto; /* Allow vertical scrolling */
        }

        #detailedInspection table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #detailedInspection th, #detailedInspection td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #detailedInspection th {
            background-color: #f2f2f2;
        }

        .highlighted-row {
            background-color: #ffffcc; /* Light yellow background color */
        }
    </style>
</head>
<body>
    <div id="mapContainer">
        <div id="viewDiv"></div>
        <button id="filterButton">Maint. Req'd = Yes</button>
        <div id="sidePanel">
            <h2>Add New Inspection</h2>
            <form id="addInspectionForm">
                <label for="inspectionDate">Inspection Date:</label>
                <input type="date" id="inspectionDate" required><br>

                <label for="conditionScore">Condition Score:</label>
                <select id="conditionScore" required>
                    <option value="">Select</option>
                    <option value="1">1 - Very Poor</option>
                    <option value="2">2 - Poor</option>
                    <option value="3">3 - Ok</option>
                    <option value="4">4 - Good</option>
                    <option value="5">5 - Very Good</option>
                </select><br>

                <label for="requiresMaintenance">Requires Maintenance:</label>
                <select id="requiresMaintenance" required>
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select><br><br>

                <input type="hidden" id="relfeatureglobalid">
                
                <div style="display: flex; justify-content: space-between;">
                    <button type="submit" id="submitInspectionButton">Submit</button>
                    <button type="button" id="clearSelectionButton">Clear Selection</button>
                </div>
            </form>
            
            <div class="line-separator"></div>
        
            <div id="infoDiv">
                <h2 id="inspectionsTitle">Previous Inspections</h2>
                <table id="infoTable">
                    <thead>
                        <tr>
                            <th>Inspection Date</th>
                            <th>Condition Score</th>
                            <th>Requires Maintenance</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="detailedInspection">
                <h2>Detailed Inspection Info</h2>
                <table>
                    <tr>
                        <th>Missing Hardware</th>
                        <td id="missingHardwareDetail"></td>
                    </tr>
                    <tr>
                        <th>Broken or Missing Slats</th>
                        <td id="brokenMissingSlatsDetail"></td>
                    </tr>
                    <tr>
                        <th>Graffiti</th>
                        <td id="graffitiDetail"></td>
                    </tr>
                    <tr>
                        <th>Support Condition</th>
                        <td id="supportConditionDetail"></td>
                    </tr>
                    <tr>
                        <th>Notes</th>
                        <td id="notesDetail"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div id="successMessage">New inspection added successfully!</div>

    <script src="https://js.arcgis.com/4.28"></script>
    <script>
        require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/Graphic",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/rest/support/Query",
    "esri/geometry/geometryEngine",
    "esri/geometry/Point",
    "esri/widgets/Locate",
    "esri/identity/IdentityManager",
    "esri/identity/OAuthInfo"
], function(Map, MapView, FeatureLayer, Graphic, SimpleMarkerSymbol, Query, geometryEngine, Point, Locate, IdentityManager, OAuthInfo) {
    const map = new Map({
        basemap: {
            portalItem: {
                id: "a11d663a981947b99aac7ff05437758f"
            }
        }
    });

    const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-93.2650, 44.9778],
        zoom: 11
    });

    const oAuthInfo = new OAuthInfo({
        appId: "ti3fi1FqvHE2Hhyw",
        popup: false // Change to true if you want to use a popup window for authentication
    });

    IdentityManager.registerOAuthInfos([oAuthInfo]);

    // Optionally set up authentication events
    IdentityManager.checkSignInStatus(oAuthInfo.portalUrl + "/sharing").then(function () {
        // User is signed in
        console.log("User is signed in");
    }).catch(function () {
        // User is not signed in
        console.log("User is not signed in");
    });

    const featureLayer = new FeatureLayer({
        url: "https://utility.arcgis.com/usrsvcs/servers/e50cdf496c194699819e28e23bbb64f4/rest/services/Asssets2/FeatureServer/4"
    });

    const inspectionLayer = new FeatureLayer({
        url: "https://utility.arcgis.com/usrsvcs/servers/e50cdf496c194699819e28e23bbb64f4/rest/services/Asssets2/FeatureServer/5"
    });

    map.add(featureLayer);
    map.add(inspectionLayer);

    let selectedFeature = null; // Store the selected feature's graphic

    featureLayer.when(() => {
        attachClickListener();
    }).catch((error) => {
        console.error("Error loading Feature Layer:", error);
    });

    function attachClickListener() {
        view.on("click", function(event) {
            if (selectedFeature) {
                view.graphics.remove(selectedFeature);
                hideDetailedInspection();
            }

            const bufferDistance = 20;
            const bufferGeometry = geometryEngine.geodesicBuffer(event.mapPoint, bufferDistance, "feet");

            let query = featureLayer.createQuery();
            query.geometry = bufferGeometry;
            query.spatialRelationship = "intersects";
            query.returnGeometry = true;
            query.outFields = ["*"];

            featureLayer.queryFeatures(query).then(function(result) {
                if (result.features.length > 0) {
                    let feature = result.features[0];
                    let objectId = feature.attributes.GlobalID;

                    // Create a graphic for the selected feature and add it to the view
                    selectedFeature = new Graphic({
                        geometry: feature.geometry,
                        symbol: new SimpleMarkerSymbol({
                            color: [226, 119, 40],
                            outline: {
                                color: [255, 255, 255],
                                width: 1
                            }
                        })
                    });
                    view.graphics.add(selectedFeature);

                    fetchInspections(objectId);
                } else {
                    console.log("No feature selected.");
                }
            }).catch(function(error) {
                console.error("Error querying features:", error);
            });
        });
    }

    function fetchInspections(objectId) {
    console.log("Fetching inspections for OBJECTID:", objectId);

    // Add console log to check relationshipId
    console.log("Relationship ID:", inspectionLayer.relationships[0].id);

    // Correctly use queryRelatedFeatures with the appropriate relationshipId
    inspectionLayer.queryRelatedFeatures({
        outFields: ["inspection_date", "condition_score", "requires_maintenance", "missing_hardware", "broken_missing_slats", "graffiti", "support_condition", "notes"], // Specify which fields to include in the returned related records
        relationshipId: inspectionLayer.relationships[0].id, // The ID of the relationship as defined in your service
        objectIds: [objectId], // OBJECTID of the selected feature
        returnGeometry: false // Set to true if you need the geometry of the related records
    }).then(function(relatedFeaturesSet) {
        // Add console log to check if related records are obtained
        console.log("Related inspections set:", relatedFeaturesSet[objectId]);

        // Accessing the related features from the returned object
        let relatedFeatures = relatedFeaturesSet[objectId].features;
        if (relatedFeatures && relatedFeatures.length > 0) {
            console.log("Related inspections found:", relatedFeatures);
            displayInspections(relatedFeatures); // Function to display related inspections
        } else {
            console.log("No related inspections found.");
            displayNoInspectionsMessage(); // Function to handle no related inspections found
        }
    }).catch(function(error) {
        console.error("Error fetching related inspections:", error);
    });
}





    function displayInspections(inspections) {
        const tbody = document.querySelector("#infoTable tbody");
        // Check if tbody exists before proceeding
        if (!tbody) {
            console.error("tbody element not found.");
            return;
        }

        tbody.innerHTML = ""; // Clear existing table rows

        inspections.forEach((inspection) => {
            const attributes = inspection.attributes;
            const row = tbody.insertRow();
            row.innerHTML = `<td>${attributes.InspectionDate}</td><td>${attributes.ConditionScore}</td><td>${attributes.RequiresMaintenance}</td>`;
        });
    }

    function displayNoInspectionsMessage() {
        const tbody = document.querySelector("#infoTable tbody");
        if (!tbody) {
            console.error("tbody element not found.");
            return;
        }

        tbody.innerHTML = "";

        let row = tbody.insertRow();
        let cell = row.insertCell();
        cell.colSpan = 3;
        cell.textContent = "No inspections found for this feature.";
    }

    function hideDetailedInspection() {
        const detailedInspectionDiv = document.getElementById("detailedInspection");
        if (detailedInspectionDiv) {
            detailedInspectionDiv.style.display = "none";
        }
    }

    function showSidePanel() {
        const sidePanel = document.getElementById("sidePanel");
        if (sidePanel) {
            sidePanel.style.display = "block";
        }
    }

    function hideSidePanel() {
        const sidePanel = document.getElementById("sidePanel");
        if (sidePanel) {
            sidePanel.style.display = "none";
        }
    }

    function clearSelection() {
        view.graphics.removeAll(); // Remove all graphics from the view
        displayNoFeatureSelectedMessage(); // Show message when no feature is selected
        hideSidePanel(); // Hide the side panel when selection is cleared
    }

    document.getElementById("clearSelectionButton").addEventListener("click", clearSelection);

    document.getElementById("filterButton").addEventListener("click", function() {
        view.whenLayerView(featureLayer).then(function(layerView) {
            layerView.filter = {
                where: "Maint_Req = 'Yes'"
            };
        });
    });

    document.getElementById("addInspectionForm").addEventListener("submit", function(event) {
        event.preventDefault();

        const inspectionDate = document.getElementById("inspectionDate").value;
        const conditionScore = document.getElementById("conditionScore").value;
        const requiresMaintenance = document.getElementById("requiresMaintenance").value;
        const relFeatureGlobalID = document.getElementById("relfeatureglobalid").value;

        const newInspection = {
            attributes: {
                InspectionDate: inspectionDate,
                ConditionScore: conditionScore,
                RequiresMaintenance: requiresMaintenance,
                RelationshipId: 20,
                RelGlobalID: relFeatureGlobalID
            },
            geometry: null
        };

        inspectionLayer.applyEdits({
            addFeatures: [newInspection]
        }).then(function() {
            document.getElementById("successMessage").style.display = "block";
            setTimeout(function() {
                document.getElementById("successMessage").style.display = "none";
            }, 3000);
            fetchInspections(relFeatureGlobalID);
        }).catch(function(error) {
            console.error("Error adding inspection:", error);
        });
    });
});
    </script>
</body>
</html>
