<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew Leader Dashboard</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        body {
            font-family: Avenir Next, sans-serif;
            display: flex;
        }
        #crewLeaderContainer {
            width: 200px;
            height: 100vh;
            overflow-y: auto;
            background-color: #f0f0f0;
            padding: 10px;
        }
        .crew-leader {
            margin: 5px 0;
            padding: 10px;
            background-color: #0079c1;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }
        #serviceAreaContainer {
            flex-grow: 1;
            padding: 10px;
        }
        .service-area, .park {
            margin: 10px;
            padding: 10px;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .service-area-name, .plus-icon {
            font-weight: bold;
            cursor: pointer;
        }
        .service-area-content, .park {
            display: none; /* Initially hide the content */
        }
    </style>
</head>
<body>
<div id="crewLeaderContainer"></div>
<div id="serviceAreaContainer"></div>

<script src="https://js.arcgis.com/4.28/"></script>
<script>
require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager",
    "esri/layers/FeatureLayer",
    "esri/rest/support/Query"
], function(OAuthInfo, esriId, FeatureLayer, Query) {
    // Initialize OAuth
    var info = new OAuthInfo({
        appId: "yourAppId", // Replace with your App ID
        popup: false // Use redirect OAuth pattern
    });
    esriId.registerOAuthInfos([info]);

    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(function() {
        console.log("User is signed in");
        loadCrewLeaders();
    }).catch(function() {
        console.log("User is not signed in");
        esriId.getCredential(info.portalUrl + "/sharing");
    });

    function loadCrewLeaders() {
        var layer = new FeatureLayer({
            url: "yourFeatureLayerUrl" // Replace with your FeatureLayer URL
        });

        var query = layer.createQuery();
        query.where = "1=1"; // Fetch all features
        query.outFields = ["*"]; // Fetch all fields
        query.returnGeometry = false;
        layer.queryFeatures(query).then(function(response) {
            processFeatures(response.features);
        });
    }

    function processFeatures(features) {
        console.log('Processing features');
        const crewLeaderMap = {};
        const serviceAreasMap = {};

        features.forEach(feature => {
            const { Maintenance_SA, Name_Primary, ASMCrewLeader } = feature.attributes;
            // Ensure service area "Southwest" is included
            serviceAreasMap[Maintenance_SA] = true;

            if (!crewLeaderMap[ASMCrewLeader]) {
                crewLeaderMap[ASMCrewLeader] = [];
            }
            crewLeaderMap[ASMCrewLeader].push(Name_Primary);
        });

        populateCrewLeaders(crewLeaderMap);
        populateServiceAreas(Object.keys(serviceAreasMap));
    }

    function populateCrewLeaders(crewLeaderMap) {
        const container = document.getElementById('crewLeaderContainer');
        Object.keys(crewLeaderMap).forEach(name => {
            const div = document.createElement('div');
            div.className = 'crew-leader';
            div.textContent = name;
            container.appendChild(div);
        });
    }

    function populateServiceAreas(serviceAreas) {
        const container = document.getElementById('serviceAreaContainer');
        serviceAreas.forEach(area => {
            const div = document.createElement('div');
            div.className = 'service-area';
            div.textContent = area;
            container.appendChild(div);
        });
    }
});
</script>
</body>
</html>
